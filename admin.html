<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Jumpi - פאנל ניהול</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css" rel="stylesheet">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Heebo:wght@400;500;700;900&display=swap" rel="stylesheet">
  <script src="https://code.jquery.com/jquery-latest.min.js"></script>
  
  <style>
	:root {
		--primary-color: #66d030;
		--title-color: #66d030;
		--secondary-color: #a1df70;
		--accent-color: #66d030;
		--description-color: #A67C52;
		--font-family: "Heebo", sans-serif;
		--blue-light: #8cd8f2;
		--blue-medium: #2eb7eb;
		--blue-dark: #0f3059;
	}
	
	p, a, h1, h2, h3, h4, h5, h6, span, label, input, th, td {
	  font-family: var(--font-family);
	}
	
	h1, h2, h3, h4, h5, h6 {
	  font-weight: 900;
	}
	
    body {
      background: linear-gradient(180deg, #f0f9e8 0%, #e8f5d8 100%);
      font-family: var(--font-family), sans-serif;
      min-height: 100vh;
      padding: 2vw;
    }
	
	.admin-container {
		max-width: 1400px;
		margin: 0 auto;
	}
	
	.admin-header {
		background: linear-gradient(135deg, #66d030 0%, #a1df70 100%);
		padding: 2vw;
		border-radius: 1vw;
		margin-bottom: 2vw;
		color: white;
		box-shadow: 0 4px 20px rgba(102, 208, 48, 0.3);
	}
	
	.admin-header h1 {
		color: white;
		font-size: 2.5vw;
		margin: 0;
	}
	
	.admin-header h1 i,
	.admin-section h2 i {
		margin-left: 0.5vw;
		font-size: 0.9em;
	}
	
	.admin-section {
		background: white;
		border-radius: 1vw;
		padding: 2vw;
		margin-bottom: 2vw;
		box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
	}
	
	.admin-section h2 {
		color: var(--primary-color);
		font-size: 2vw;
		margin-bottom: 1.5vw;
		border-bottom: 3px solid var(--secondary-color);
		padding-bottom: 0.5vw;
	}
	
	.subscribers-table {
		width: 100%;
		border-collapse: collapse;
		margin-top: 1vw;
	}
	
	.subscribers-table th {
		background: linear-gradient(180deg, var(--blue-light) 0%, var(--blue-medium) 100%);
		color: white;
		padding: 1vw;
		text-align: right;
		font-weight: 700;
		font-size: 1.2vw;
	}
	
	.subscribers-table td {
		padding: 1vw;
		border-bottom: 1px solid #e0e0e0;
		font-size: 1.1vw;
	}
	
	.subscribers-table tr:hover {
		background: #f5f5f5;
	}
	
	.send-update-form {
		background: linear-gradient(180deg, rgba(161, 223, 112, 0.1) 0%, rgba(140, 216, 242, 0.1) 100%);
		padding: 2vw;
		border-radius: 1vw;
		border: 2px solid var(--secondary-color);
	}
	
	.form-group {
		margin-bottom: 1.5vw;
	}
	
	.form-group label {
		display: block;
		margin-bottom: 0.5vw;
		font-weight: 700;
		color: var(--primary-color);
		font-size: 1.2vw;
	}
	
	.form-control {
		width: 100%;
		padding: 0.8vw;
		border: 2px solid var(--blue-light);
		border-radius: 0.5vw;
		font-size: 1.1vw;
		font-family: var(--font-family);
		transition: border-color 0.3s;
	}
	
	.form-control:focus {
		outline: none;
		border-color: var(--blue-medium);
		box-shadow: 0 0 0 0.2vw rgba(46, 183, 235, 0.2);
	}
	
	textarea.form-control {
		min-height: 150px;
		resize: vertical;
	}
	
	.btn-admin {
		padding: 0.8vw 2vw;
		font-size: 1.2vw;
		font-weight: 700;
		border-radius: 0.5vw;
		border: none;
		cursor: pointer;
		transition: all 0.3s;
	}
	
	.btn-send {
		background: linear-gradient(0deg, #66d030 62%, #a1df70 111%);
		color: white;
	}
	
	.btn-send:hover {
		background: linear-gradient(0deg, #5ab825 62%, #8fcc5a 111%);
		transform: translateY(-2px);
		box-shadow: 0 4px 12px rgba(102, 208, 48, 0.4);
	}
	
	.btn-refresh {
		background: linear-gradient(0deg, var(--blue-medium) 62%, var(--blue-light) 111%);
		color: white;
		margin-bottom: 1vw;
	}
	
	.btn-refresh:hover {
		background: linear-gradient(0deg, #28a5d9 62%, #7bc8e2 111%);
		transform: translateY(-2px);
		box-shadow: 0 4px 12px rgba(46, 183, 235, 0.4);
	}
	
	.stats-box {
		display: flex;
		gap: 2vw;
		margin-bottom: 2vw;
	}
	
	.stat-card {
		flex: 1;
		background: linear-gradient(135deg, var(--blue-light) 0%, var(--blue-medium) 100%);
		padding: 1.5vw;
		border-radius: 1vw;
		color: white;
		text-align: center;
		box-shadow: 0 4px 15px rgba(46, 183, 235, 0.3);
		cursor: pointer;
		transition: transform 0.3s, box-shadow 0.3s;
	}
	
	.stat-card:hover {
		transform: translateY(-5px);
		box-shadow: 0 6px 20px rgba(46, 183, 235, 0.4);
	}
	
	.modal {
		display: none;
		position: fixed;
		z-index: 1000;
		left: 0;
		top: 0;
		width: 100%;
		height: 100%;
		background-color: rgba(0, 0, 0, 0.5);
		backdrop-filter: blur(5px);
	}
	
	.modal-content {
		background-color: white;
		margin: 5% auto;
		padding: 2vw;
		border-radius: 1vw;
		width: 80%;
		max-width: 1000px;
		max-height: 80vh;
		overflow-y: auto;
		box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3);
	}
	
	.modal-header {
		display: flex;
		justify-content: space-between;
		align-items: center;
		margin-bottom: 1.5vw;
		padding-bottom: 1vw;
		border-bottom: 3px solid var(--secondary-color);
	}
	
	.modal-header h2 {
		color: var(--primary-color);
		font-size: 2vw;
		margin: 0;
	}
	
	.close {
		color: #aaa;
		font-size: 2.5vw;
		font-weight: bold;
		cursor: pointer;
		background: none;
		border: none;
		padding: 0;
		width: 3vw;
		height: 3vw;
		display: flex;
		align-items: center;
		justify-content: center;
		border-radius: 50%;
		transition: all 0.3s;
	}
	
	.close:hover {
		color: #000;
		background: #f0f0f0;
	}
	
	.stat-card h3 {
		font-size: 3vw;
		margin: 0;
		color: white;
	}
	
	.stat-card p {
		font-size: 1.2vw;
		margin: 0.5vw 0 0 0;
		opacity: 0.9;
	}
	
	.alert {
		padding: 1vw;
		border-radius: 0.5vw;
		margin-top: 1vw;
		font-size: 1.1vw;
	}
	
	.alert-success {
		background: rgba(102, 208, 48, 0.2);
		color: #2e7d32;
		border: 2px solid var(--primary-color);
	}
	
	.alert-error {
		background: rgba(244, 67, 54, 0.2);
		color: #c62828;
		border: 2px solid #f44336;
	}
	
	.loading {
		text-align: center;
		padding: 2vw;
		font-size: 1.2vw;
		color: var(--primary-color);
	}
	
	.empty-state {
		text-align: center;
		padding: 3vw;
		color: #999;
		font-size: 1.3vw;
	}
	
	/* Code Input Modal */
	.code-modal {
		display: block;
		position: fixed;
		z-index: 2000;
		left: 0;
		top: 0;
		width: 100%;
		height: 100%;
		background-color: rgba(0, 0, 0, 0.7);
		backdrop-filter: blur(5px);
	}
	
	.code-modal-content {
		background: linear-gradient(180deg, #f0f9e8 0%, #e8f5d8 100%);
		margin: 15% auto;
		padding: 3vw;
		border-radius: 2vw;
		width: 90%;
		max-width: 500px;
		box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
		text-align: center;
		border: 3px solid var(--primary-color);
	}
	
	.code-modal-content h2 {
		color: var(--primary-color);
		font-size: 2.5vw;
		margin-bottom: 1.5vw;
	}
	
	.code-input-container {
		display: flex;
		justify-content: center;
		gap: 1vw;
		margin: 2vw 0;
	}
	
	.code-digit {
		width: 4vw;
		height: 5vw;
		font-size: 2.5vw;
		text-align: center;
		border: 3px solid var(--blue-light);
		border-radius: 1vw;
		font-weight: 900;
		font-family: var(--font-family);
		transition: all 0.3s;
		background: white;
		color: var(--primary-color);
	}
	
	.code-digit:focus {
		outline: none;
		border-color: var(--blue-medium);
		box-shadow: 0 0 0 0.3vw rgba(46, 183, 235, 0.3);
		transform: scale(1.05);
	}
	
	.code-error {
		color: #f44336;
		margin-top: 1vw;
		font-size: 1.2vw;
		display: none;
	}
	
	.code-error.show {
		display: block;
	}
	
	@media (max-width: 1024px) {
		.admin-header h1 {
			font-size: 6vw;
		}
		
		.admin-section h2 {
			font-size: 5vw;
		}
		
		.subscribers-table th,
		.subscribers-table td {
			font-size: 3vw;
			padding: 2vw;
		}
		
		.form-group label {
			font-size: 4vw;
		}
		
		.form-control {
			font-size: 4vw;
			padding: 2vw;
		}
		
		.btn-admin {
			font-size: 4vw;
			padding: 2vw 4vw;
		}
		
		.stat-card h3 {
			font-size: 8vw;
		}
		
		.stat-card p {
			font-size: 4vw;
		}
		
		.stats-box {
			flex-direction: column;
		}
		
		.modal-content {
			width: 95%;
			margin: 10% auto;
			padding: 4vw;
			max-height: 85vh;
		}
		
		.modal-header h2 {
			font-size: 5vw;
		}
		
		.close {
			font-size: 6vw;
			width: 8vw;
			height: 8vw;
		}
		
		.code-modal-content {
			padding: 5vw;
			width: 95%;
			margin: 20% auto;
		}
		
		.code-modal-content h2 {
			font-size: 6vw;
		}
		
		.code-digit {
			width: 12vw;
			height: 15vw;
			font-size: 8vw;
		}
		
		.code-input-container {
			gap: 2vw;
		}
		
		.code-error {
			font-size: 4vw;
		}
	}
  </style>
</head>
<body>

  <!-- Code Input Modal -->
  <div id="codeModal" class="code-modal">
    <div class="code-modal-content">
      <h2><i class="bi bi-shield-lock"></i> הזן קוד גישה</h2>
      <div class="code-input-container">
        <input type="text" class="code-digit" id="code1" maxlength="1" pattern="[0-9]">
        <input type="text" class="code-digit" id="code2" maxlength="1" pattern="[0-9]">
        <input type="text" class="code-digit" id="code3" maxlength="1" pattern="[0-9]">
        <input type="text" class="code-digit" id="code4" maxlength="1" pattern="[0-9]">
      </div>
      <div class="code-error" id="codeError">קוד שגוי, נסה שוב</div>
      <button type="button" class="btn-admin btn-send" onclick="submitCode()" style="margin-top: 1vw;">
        <i class="bi bi-check-circle"></i> כניסה
      </button>
    </div>
  </div>

  <div class="admin-container" id="adminContent" style="display: none;">
	
	<div class="admin-header">
		<h1><i class="bi bi-shield-lock"></i> פאנל ניהול - Jumpi</h1>
		<p style="margin: 0.5vw 0 0 0; font-size: 1.2vw; opacity: 0.9;">ניהול נרשמים ושליחת עדכונים</p>
	</div>
	
	<div class="stats-box">
		<div class="stat-card" onclick="openSubscribersModal()">
			<h3 id="totalSubscribers">0</h3>
			<p>נרשמים בסך הכל</p>
		</div>
		<div class="stat-card" style="background: linear-gradient(135deg, var(--secondary-color) 0%, var(--primary-color) 100%);">
			<h3 id="todaySubscribers">0</h3>
			<p>נרשמו היום</p>
		</div>
	</div>
	
	<!-- Modal for Subscribers List -->
	<div id="subscribersModal" class="modal">
		<div class="modal-content">
			<div class="modal-header">
				<h2><i class="bi bi-list-check"></i> רשימת נרשמים</h2>
				<button class="close" onclick="closeSubscribersModal()">&times;</button>
			</div>
			<button class="btn-admin btn-refresh" onclick="loadSubscribers()">
				<i class="bi bi-arrow-clockwise"></i> רענן רשימה
			</button>
			<div id="subscribersList">
				<div class="loading">טוען נתונים...</div>
			</div>
		</div>
	</div>
	
	<div class="admin-section">
		<h2><i class="bi bi-envelope-paper"></i> שליחת עדכון לכל הנרשמים</h2>
		<div class="send-update-form">
			<form id="sendUpdateForm" onsubmit="sendUpdate(event)">
				<div class="form-group">
					<label for="updateSubject">נושא ההודעה:</label>
					<input type="text" class="form-control" id="updateSubject" required placeholder="לדוגמה: ג'אמפי יוצא בקרוב!">
				</div>
				<div class="form-group">
					<label for="updateMessage">תוכן ההודעה:</label>
					<textarea class="form-control" id="updateMessage" required placeholder="כתוב כאן את ההודעה שתישלח לכל הנרשמים..."></textarea>
				</div>
				<button type="submit" class="btn-admin btn-send">
					<i class="bi bi-send"></i> שלח עדכון לכל הנרשמים
				</button>
				<div id="sendUpdateAlert"></div>
			</form>
		</div>
	</div>
	
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
  <script>
  
  // Mock data for demonstration - replace with actual API calls
  let subscribers = [];
  
  // Check authentication on page load
  function checkAuth() {
    $.ajax({
      url: '/api/admin/check-auth',
      xhrFields: {
        withCredentials: true
      }
    })
      .done(function(response) {
        if (response.authenticated) {
          $('#codeModal').css('display', 'none');
          $('#adminContent').css('display', 'block');
          loadStats();
        } else {
          $('#codeModal').css('display', 'block');
          $('#adminContent').css('display', 'none');
          // Focus first input
          setTimeout(function() {
            $('#code1').focus();
          }, 100);
        }
      })
      .fail(function() {
        $('#codeModal').css('display', 'block');
        $('#adminContent').css('display', 'none');
        setTimeout(function() {
          $('#code1').focus();
        }, 100);
      });
  }
  
  // Code input handling
  function setupCodeInputs() {
    const inputs = ['code1', 'code2', 'code3', 'code4'];
    
    inputs.forEach((id, index) => {
      const input = document.getElementById(id);
      if (input) {
        input.addEventListener('input', function(e) {
          // Only allow numbers
          this.value = this.value.replace(/[^0-9]/g, '');
          
          // Move to next input
          if (this.value && index < inputs.length - 1) {
            document.getElementById(inputs[index + 1]).focus();
          }
        });
        
        input.addEventListener('keydown', function(e) {
          // Backspace handling
          if (e.key === 'Backspace' && !this.value && index > 0) {
            document.getElementById(inputs[index - 1]).focus();
          }
          // Enter to submit
          if (e.key === 'Enter' && index === inputs.length - 1) {
            submitCode();
          }
        });
      }
    });
  }
  
  function submitCode() {
    const code = $('#code1').val() + $('#code2').val() + $('#code3').val() + $('#code4').val();
    
    if (code.length !== 4) {
      showCodeError('אנא הזן 4 ספרות');
      return;
    }
    
    $('#codeError').removeClass('show');
    
    $.ajax({
      url: '/api/admin/login',
      method: 'POST',
      contentType: 'application/json',
      data: JSON.stringify({ code: code }),
      xhrFields: {
        withCredentials: true
      },
      success: function(response) {
        if (response.success) {
          $('#codeModal').css('display', 'none');
          $('#adminContent').css('display', 'block');
          // Clear code inputs
          $('#code1, #code2, #code3, #code4').val('');
          // Load stats after authentication
          loadStats();
        }
      },
      error: function(xhr) {
        const errorMsg = xhr.responseJSON?.error || 'קוד שגוי';
        showCodeError(errorMsg);
        // Clear inputs and refocus
        $('#code1, #code2, #code3, #code4').val('');
        setTimeout(function() {
          $('#code1').focus();
        }, 100);
      }
    });
  }
  
  function showCodeError(message) {
    $('#codeError').text(message).addClass('show');
    setTimeout(function() {
      $('#codeError').removeClass('show');
    }, 3000);
  }
  
  function openSubscribersModal() {
    // Check auth first
    $.ajax({
      url: '/api/admin/check-auth',
      xhrFields: {
        withCredentials: true
      }
    })
      .done(function(response) {
        if (response.authenticated) {
          const modal = document.getElementById('subscribersModal');
          if (modal) {
            modal.style.display = 'block';
            if (subscribers.length === 0) {
              loadSubscribers();
            }
          }
        } else {
          checkAuth();
        }
      })
      .fail(function() {
        checkAuth();
      });
  }
  
  function closeSubscribersModal() {
    const modal = document.getElementById('subscribersModal');
    if (modal) {
      modal.style.display = 'none';
    }
  }
  
  // Close modal when clicking outside of it
  window.onclick = function(event) {
    const modal = document.getElementById('subscribersModal');
    if (event.target == modal) {
      closeSubscribersModal();
    }
  }
  
  function loadSubscribers() {
    const container = document.getElementById('subscribersList');
    container.innerHTML = '<div class="loading">טוען נתונים...</div>';
    
    $.ajax({
      url: '/api/admin/subscribers',
      xhrFields: {
        withCredentials: true
      }
    })
      .done(function(data) {
        subscribers = data;
        renderSubscribers();
        updateStats();
      })
      .fail(function(xhr) {
        if (xhr.status === 401) {
          checkAuth(); // Re-authenticate if needed
          container.innerHTML = '<div class="empty-state">נדרש אימות מחדש</div>';
        } else {
          container.innerHTML = '<div class="empty-state">שגיאה בטעינת הרשימה. נסה שוב.</div>';
        }
        console.error('Error loading subscribers:', xhr);
      });
  }
  
  function loadStats() {
    $.ajax({
      url: '/api/admin/stats',
      xhrFields: {
        withCredentials: true
      }
    })
      .done(function(data) {
        document.getElementById('totalSubscribers').textContent = data.total;
        document.getElementById('todaySubscribers').textContent = data.today;
      })
      .fail(function(xhr) {
        if (xhr.status === 401) {
          checkAuth(); // Re-authenticate if needed
        }
        console.error('Error loading stats:', xhr);
      });
  }
  
  function renderSubscribers() {
    const container = document.getElementById('subscribersList');
    
    if (subscribers.length === 0) {
      container.innerHTML = '<div class="empty-state">אין נרשמים עדיין</div>';
      return;
    }
    
    let html = '<table class="subscribers-table"><thead><tr><th>מספר</th><th>שם מלא</th><th>אימייל</th><th>סוג</th><th>תאריך הרשמה</th></tr></thead><tbody>';
    
    subscribers.forEach(function(sub, index) {
      const typeText = sub.type === 'parent' ? 'הורה' : 'שחקן';
      html += `<tr>
        <td>${index + 1}</td>
        <td>${sub.name}</td>
        <td>${sub.email}</td>
        <td>${typeText}</td>
        <td>${sub.date}</td>
      </tr>`;
    });
    
    html += '</tbody></table>';
    container.innerHTML = html;
  }
  
  function updateStats() {
    // Stats are loaded separately via API (only if authenticated)
    if ($('#adminContent').is(':visible')) {
      loadStats();
    }
  }
  
  // Load stats when content is shown
  $(document).on('DOMContentLoaded', function() {
    $('#adminContent').on('show', function() {
      loadStats();
    });
  });
  
  function sendUpdate(event) {
    event.preventDefault();
    
    const subject = document.getElementById('updateSubject').value;
    const message = document.getElementById('updateMessage').value;
    const alertDiv = document.getElementById('sendUpdateAlert');
    
    $.ajax({
      url: '/api/admin/send-update',
      method: 'POST',
      contentType: 'application/json',
      data: JSON.stringify({ subject: subject, message: message }),
      xhrFields: {
        withCredentials: true
      },
      success: function(response) {
        if (response.success) {
          showAlert(alertDiv, response.message || `העדכון "${subject}" נשלח בהצלחה ל-${response.sentTo} נרשמים!`, 'success');
          document.getElementById('sendUpdateForm').reset();
        } else {
          showAlert(alertDiv, response.error || 'שגיאה בשליחת העדכון', 'error');
        }
      },
      error: function(xhr) {
        const errorMsg = xhr.responseJSON?.error || 'שגיאה בשליחת העדכון. נסה שוב.';
        showAlert(alertDiv, errorMsg, 'error');
      }
    });
    
    // Clear alert after 5 seconds
    setTimeout(function() {
      alertDiv.innerHTML = '';
    }, 5000);
  }
  
  function showAlert(container, message, type) {
    const alertClass = type === 'success' ? 'alert-success' : 'alert-error';
    container.innerHTML = `<div class="alert ${alertClass}">${message}</div>`;
  }
  
  // Load subscribers and stats on page load
  document.addEventListener('DOMContentLoaded', function() {
    setupCodeInputs();
    checkAuth();
    // Don't load stats/subscribers until authenticated
  });
  
  </script>
</body>
</html>

